name: Build Plugin

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      BUILD_NUMBER: ${{ github.run_number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure Gradle wrapper jar
        shell: bash
        run: |
          if [ -f gradle/wrapper/gradle-wrapper.jar ]; then
            echo "Wrapper jar present"
            exit 0
          fi
          echo "gradle-wrapper.jar missing; rebuilding from distributionUrl"
          DIST_URL=$(grep distributionUrl gradle/wrapper/gradle-wrapper.properties | cut -d= -f2 | tr -d '\r')
          if [ -z "$DIST_URL" ]; then
            echo "distributionUrl not found in gradle-wrapper.properties" >&2
            exit 1
          fi
          TEMP_ZIP=/tmp/gradle-dist.zip
          curl -sSL "$DIST_URL" -o "$TEMP_ZIP"
          unzip -q "$TEMP_ZIP" -d /tmp/gradle-dist
          WRAPPER_JAR=$(find /tmp/gradle-dist -name gradle-wrapper-*.jar | head -n1)
          if [ -z "$WRAPPER_JAR" ]; then
            echo "Failed to locate gradle-wrapper jar in distribution" >&2
            exit 1
          fi
          mkdir -p gradle/wrapper
          cp "$WRAPPER_JAR" gradle/wrapper/gradle-wrapper.jar
          echo "Wrapper jar restored"

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Grant execute permission for Gradle wrapper
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean build --no-daemon

      - name: Capture version and metadata
        id: meta
        shell: bash
        run: |
          VERSION=$(./gradlew properties -q | grep "^version:" | awk '{print $2}')
          SHORT_SHA="${GITHUB_SHA::7}"
          ARTIFACT="MultiPlayerInvSync-${VERSION}-b${BUILD_NUMBER}-${SHORT_SHA}.jar"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "short_sha=$SHORT_SHA" >> "$GITHUB_OUTPUT"
          echo "artifact=$ARTIFACT" >> "$GITHUB_OUTPUT"
          echo "Detected version: $VERSION" >> "$GITHUB_STEP_SUMMARY"
          echo "Artifact: $ARTIFACT" >> "$GITHUB_STEP_SUMMARY"

      - name: Rename artifact with version
        shell: bash
        run: |
          TARGET=${{ steps.meta.outputs.artifact }}
          mkdir -p build/out
          JAR_PATH=$(find build/libs -maxdepth 1 -type f -name "*.jar" | head -n1)
          if [ -z "$JAR_PATH" ]; then
            echo "No jar found in build/libs" >&2
            exit 1
          fi
          cp "$JAR_PATH" "build/out/${TARGET}"

      - name: Upload plugin JAR
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.artifact }}
          path: build/out/${{ steps.meta.outputs.artifact }}
          if-no-files-found: error

      - name: Build summary
        run: |
          echo "### Build Output" >> "$GITHUB_STEP_SUMMARY"
          echo "- Version: ${{ steps.meta.outputs.version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Artifact: ${{ steps.meta.outputs.artifact }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Commit: ${{ steps.meta.outputs.short_sha }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Build #: $BUILD_NUMBER" >> "$GITHUB_STEP_SUMMARY"
          echo "- Java: 21 (Temurin)" >> "$GITHUB_STEP_SUMMARY"
          echo "- OS: Ubuntu-latest" >> "$GITHUB_STEP_SUMMARY"
